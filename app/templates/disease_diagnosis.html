<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disease Diagnosis</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50 flex flex-col">
    {% block navbar %}
        {% include 'user_navbar.html' %}
    {% endblock %}<br>
    <div class="mt-10 flex justify-start w-4/5 ml-10">
        <!-- Symptom Selection Box -->
        <div class="bg-white p-6 rounded-lg shadow-lg w-3/4">
            <h2 class="text-center text-2xl font-bold text-green-700">Select Symptoms</h2>

            <!-- Symptom Dropdown -->
            <label class="block mt-4 text-lg" for="symptom-select">Symptoms:</label>
            <select id="symptom-select" class="w-full p-2 mt-2 border rounded-md" onchange="addSymptom(this.value)">
                <option value="" disabled selected>Select a symptom</option>
                {% for symptom in symptoms %}
                    <option value="{{ symptom.symptom_name }}">{{ symptom.symptom_name }}</option>
                {% endfor %}
            </select>
            <div id="selected-symptoms" class="mt-4 hidden"></div>
            <input type="hidden" name="symptoms">

            <!-- Upload Image Section -->
            <h3 class="mt-6 text-lg font-semibold text-green-700">Or Upload an Image</h3>
            <input type="file" id="image-upload" accept="image/*" class="mt-2 w-full p-2 border rounded-md" onchange="previewImage()">
            <div id="image-preview-container" class="mt-4 hidden">
                <p class="text-gray-600">Selected Image:</p>
                <img id="image-preview" class="mt-2 rounded-md shadow-md w-40 h-40 object-cover">
            </div>

            <!-- Diagnose Button -->
            <button onclick="diagnose()" class="w-full mt-4 bg-green-600 text-white py-2 rounded-md hover:bg-green-700 font-semibold">
                Diagnose
            </button>
        </div>
    
        <!-- Diagnosis Result Box -->
        <div id="diagnosis-box" class="bg-white p-6 rounded-lg shadow-lg w-3/4 ml-5 hidden">
            <h2 class="text-center text-2xl font-bold text-green-700">Diagnosis Result</h2>
            <div id="diagnosis_result" class="mt-4 text-center"></div>
        </div>
    </div>
    
    <!-- Past Diagnoses Section -->
    <div class="w-4/5 ml-10 mt-10 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold text-green-700 flex justify-between items-center">
            Past Diagnoses
            <button onclick="togglePastDiagnoses()" class="text-green-600 font-semibold">[Toggle]</button>
        </h2>
        <ul id="past_diagnoses" class="mt-4"></ul>
    </div>
    
    <!-- Disease Details Modal -->
    <div id="disease-details" class="hidden fixed inset-0 flex items-start justify-center overflow-y-auto bg-black bg-opacity-50 z-50 transition-all duration-300 ease-in-out">
        <div class="relative bg-white rounded-lg shadow-lg mt-20 max-h-[80vh] w-full max-w-2xl overflow-y-auto p-6">
            <button onclick="closeDiseaseDetails()" class="absolute top-2 right-2 text-red-600 font-bold text-xl">&times;</button>
            <h2 class="text-2xl font-bold text-green-700">Disease Details</h2>
            <div id="disease-info" class="mt-4"></div>
        </div>
    </div>
    <br>

    <script>
        let selectedSymptoms = [];

        // Load past diagnoses from local storage
        document.addEventListener("DOMContentLoaded", loadPastDiagnoses);

        function addSymptom(symptom) {
            if (!selectedSymptoms.includes(symptom) && symptom !== "") {
                selectedSymptoms.push(symptom);
                updateSelectedSymptoms();
            }
        }

        function updateSelectedSymptoms() {
            const container = document.getElementById("selected-symptoms");
            container.innerHTML = "";

            if (selectedSymptoms.length === 0) {
                container.classList.add("hidden");
            } else {
                container.classList.remove("hidden");

                selectedSymptoms.forEach(symptom => {
                    const div = document.createElement("div");
                    div.classList.add("bg-green-100", "p-2", "rounded-md", "mr-2", "mt-2", "inline-flex", "items-center");
                    div.textContent = symptom;

                    const button = document.createElement("button");
                    button.classList.add("ml-2", "bg-red-500", "text-white", "rounded", "px-2", "py-1");
                    button.innerHTML = "&times;";
                    button.onclick = () => removeSymptom(symptom);

                    div.appendChild(button);
                    container.appendChild(div);
                });
            }

            // ðŸ‘‡ Update the hidden input here
            const hiddenInput = document.getElementById("hidden-symptoms");
            hiddenInput.value = selectedSymptoms.join(",");
        }

        function removeSymptom(symptom) {
            selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
            updateSelectedSymptoms();
        }

        function diagnose() {
            if (selectedSymptoms.length === 0) {
                alert("Please select at least one symptom.");
                return;
            }

            document.getElementById("diagnosis-box").classList.remove("hidden");
            document.getElementById("diagnosis_result").innerHTML = "<p class='text-gray-600'>Analyzing symptoms...</p>";

            let formData = new FormData();
            formData.append("symptoms", selectedSymptoms.join(","));

            // Get the selected image file
            const imageInput = document.getElementById("image-upload");
            if (imageInput.files.length > 0) {
                formData.append("image", imageInput.files[0]); // Append image to FormData
            }

            fetch("/diagnose_diseases", {
                method: "POST",
                body: formData,
            })
            .then(response => response.json()) // Expecting JSON response from Flask
            .then(data => {
                if (data.predicted_disease && data.results) {
                    let diagnosisHtml = `<p class='text-lg font-bold text-green-700'>Predicted Disease: <span class='text-red-600'>${data.predicted_disease}</span></p>`;

                    diagnosisHtml += "<p class='text-lg mt-2 font-semibold'>Probability Breakdown:</p>";
                    diagnosisHtml += "<ul class='mt-2'>";

                    // Loop through results and display probabilities
                    for (let disease in data.results) {
                        diagnosisHtml += `
                            <li class='text-green-700 font-semibold cursor-pointer' onclick="showDiseaseDetails('${disease}')">
                                ${disease}: ${data.results[disease]}%
                            </li>
                        `;
                    }

                    diagnosisHtml += "</ul>";

                    document.getElementById("diagnosis_result").innerHTML = diagnosisHtml;
                } else {
                    document.getElementById("diagnosis_result").innerHTML = "<p class='text-red-600'>No matching diseases found.</p>";
                }
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById("diagnosis_result").innerHTML = "<p class='text-red-600'>Error processing diagnosis. Try again.</p>";
            });
        }

        function saveDiagnosis(results) {
            let pastDiagnoses = JSON.parse(localStorage.getItem("past_diagnoses")) || [];
            pastDiagnoses.push({ symptoms: [...selectedSymptoms], results, date: new Date().toLocaleString() });
            localStorage.setItem("past_diagnoses", JSON.stringify(pastDiagnoses));
        }

        function loadPastDiagnoses() {
            let pastDiagnoses = JSON.parse(localStorage.getItem("past_diagnoses")) || [];
            const container = document.getElementById("past_diagnoses");
            container.innerHTML = pastDiagnoses.length ? "" : "<p class='text-gray-500'>No past diagnoses found.</p>";
            
            pastDiagnoses.forEach((entry, index) => {
                const li = document.createElement("li");
                li.classList.add("border-b", "py-2", "text-gray-700");
                li.innerHTML = `ðŸ•’ <strong>${entry.date}</strong> - Symptoms: ${entry.symptoms.join(", ")}<br>` +
                    entry.results.map(res => `<span class="text-green-700 cursor-pointer" onclick="showDiseaseDetails('${res.name}')">${res.name}: ${res.probability}%</span>`).join(" ");
                container.appendChild(li);
            });
        }

        function togglePastDiagnoses() {
            const section = document.getElementById("past_diagnoses");
            section.classList.toggle("hidden");
        }

        function showDiseaseDetails(diseaseName) {
            fetch(`/get_disease_details/${encodeURIComponent(diseaseName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById("disease-info").innerHTML = `<strong>Error:</strong> ${data.error}`;
                    } else {
                        let symptomsList = data.symptoms.length > 0
                            ? data.symptoms.map(symptom => `<li class="text-gray-700">âœ… ${symptom}</li>`).join("")
                            : "<li class='text-gray-500'>No symptoms available.</li>";

                        document.getElementById("disease-info").innerHTML = `
                            <p class='text-lg font-bold text-red-600'>${data.disease_name}</p>
                            <p><strong>Description:</strong> ${data.description || "No description available."}</p>
                            <p><strong>Causes:</strong> ${data.causes || "Unknown"}</p>
                            <p><strong>Prevention Tips:</strong> ${data.prevention_tips || "No prevention tips available."}</p>
                            <p><strong>Symptoms:</strong></p>
                            <ul class="ml-4 list-disc">${symptomsList}</ul>
                            <p class="text-gray-500 text-sm">Last Updated: ${data.last_updated}</p>
                        `;
                    }
                    document.getElementById("disease-details").classList.remove("hidden");
                })
                .catch(error => {
                    console.error("Error fetching disease details:", error);
                    document.getElementById("disease-info").innerHTML = "<p class='text-red-600'>Error retrieving disease details.</p>";
                });
        }


        function closeDiseaseDetails() {
            document.getElementById("disease-details").classList.add("hidden");
        }
        function previewImage() {
            const fileInput = document.getElementById("image-upload");
            const previewContainer = document.getElementById("image-preview-container");
            const previewImage = document.getElementById("image-preview");

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function (e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.remove("hidden");
                };

                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>
