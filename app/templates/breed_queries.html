<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breed Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50 text-green-900">

    <!-- Sidebar -->
    <div class="w-72 fixed h-full bg-green-800 text-white p-5 shadow-lg">
        <h2 class="text-xl font-bold text-center border-b border-green-600 pb-2">üìë Queries</h2>
        <nav class="mt-5 space-y-2">
            <a href="/home" class="block p-3 bg-green-700 rounded-lg hover:bg-green-600 transition">üè† Home</a>
            <button id="new-chat-btn" class="block w-full p-3 bg-green-700 rounded-lg hover:bg-green-600 transition">
                ‚ûï New Chat
            </button>
        </nav>
        <div id="chat-list" class="mt-5 space-y-3">
            {% for chat in chats %}
                <div class="flex justify-between items-center p-2 bg-green-700 rounded-lg" data-id="{{ chat.chat_id }}">
                    <a href="#" onclick="loadChat('{{ chat.chat_id }}')" class="text-white">{{ chat.chat_title }}</a>
                    <div class="flex gap-2">
                        <button onclick="renameChat('{{ chat.chat_id }}')" class="text-white hover:text-yellow-400">‚úèÔ∏è</button>
                        <button onclick="deleteChat('{{ chat.chat_id }}')" class="text-white hover:text-red-400">üóëÔ∏è</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Header -->
    <header class="bg-green-700 text-white text-center py-4 text-lg font-bold fixed top-0 left-72 w-[calc(100%-18rem)]">
        üêî Breed Related Queries
    </header>

    <!-- Main Content -->
    <div class="ml-72 pt-16 flex flex-col items-center px-5">
        <div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-3xl">
            <label for="breed-select" class="block font-bold">Select Breed:</label>
            <select id="breed-select" onchange="updateBreedImage()" class="w-full p-2 border border-green-400 rounded-lg mt-2">
                {% for breed in breeds %}
                    <option value="{{ breed.breed_name }}" data-images="{{ breed.breed_images | map(attribute='image_url') | join(',') }}">
                        {{breed.breed_name}}
                    </option>
                {% endfor %}
            </select>

            <!-- Breed Images -->
            <div class="flex justify-center gap-4 mt-5">
                <img class="breed-image hidden rounded-lg w-24 h-24 shadow-lg">
                <img class="breed-image hidden rounded-lg w-24 h-24 shadow-lg">
                <img class="breed-image hidden rounded-lg w-24 h-24 shadow-lg">
            </div>

            <!-- Chat Box -->
            <div class="chat-box border border-green-300 bg-green-50 p-4 mt-5 h-64 overflow-y-auto rounded-lg shadow-md"></div>

            <!-- Input Box -->
            <div class="mt-4 flex gap-3">
                <input type="text" id="user-input" class="flex-1 p-3 border border-green-400 rounded-lg" placeholder="Ask about a breed...">
                <button onclick="sendMessage()" class="bg-green-700 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition">Send</button>
            </div>
        </div>
    </div>

    <script>
        let activeChatId = null;

        function sendMessage() {
            let inputField = document.getElementById("user-input");
            let breedSelect = document.getElementById("breed-select");
            let userMessage = inputField.value.trim();
            let selectedBreed = breedSelect.value;
            let chatBox = document.querySelector(".chat-box");

            if (userMessage === "") return;

            // Append user message
            chatBox.insertAdjacentHTML("beforeend", `<div class="chat-message user-message bg-green-200 p-3 rounded-lg max-w-full self-end shadow-md"> 
                <strong>You:</strong> (${selectedBreed}) ${userMessage} 
            </div><br>`);


            fetch("/get_chat_response", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: activeChatId || null,  // Ensure correct handling for new chats
                    breed: selectedBreed,
                    message: userMessage
                }),
            })
            .then(response => response.json())
            .then(data => {
                let formattedResponse = formatResponse(data.response);
                chatBox.insertAdjacentHTML("beforeend", `<div class="chat-message bot-message bg-white p-3 rounded-lg max-w-full shadow-md"> 
                    ${formattedResponse} 
                </div>`);

                chatBox.scrollTop = chatBox.scrollHeight;

                // Update chat ID if it's a new chat
                if (!activeChatId && data.chat_id) {
                    activeChatId = data.chat_id;
                    addChatToSidebar(data.chat_id, data.chat_title);
                }
            })
            .catch(() => {
                chatBox.insertAdjacentHTML("beforeend", `<div class="chat-message bot-message" style="color:red;">An error occurred. Please try again.</div>`);
            });

            inputField.value = "";
        }

        // Function to format Markdown-style text into HTML
        function formatResponse(text) {
            let lines = text.split("\n");
            let formattedText = "";
            let inList = false;

            lines.forEach(line => {
                line = line.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>"); // Convert **bold** to <strong>

                if (line.startsWith("##")) {
                    if (inList) {
                        formattedText += "</ul>"; // Close list before adding a heading
                        inList = false;
                    }
                    formattedText += `<h3 class="text-lg font-bold text-green-800 mt-2">${line.replace(/##\s*/, "")}</h3>`;
                } else if (line.startsWith("-")) {
                    if (!inList) {
                        formattedText += "<ul class='list-disc list-inside mt-1'>"; // Open list before adding list items
                        inList = true;
                    }
                    formattedText += `<li class="text-green-700">${line.replace(/-\s*/, "")}</li>`;
                } else {
                    if (inList) {
                        formattedText += "</ul>"; // Close list before adding normal text
                        inList = false;
                    }
                    formattedText += `<p class="text-base text-green-900">${line}</p>`;
                }
            });

            if (inList) {
                formattedText += "</ul>"; // Ensure list is closed at the end
            }

            return formattedText;
        }

        function loadChat(chatId) {
            activeChatId = chatId;
            let chatBox = document.querySelector(".chat-box");
            chatBox.innerHTML = "<p>Loading chat...</p>";

            fetch(`/get_chat_queries/${chatId}`)
            .then(response => response.json())
            .then(data => {
                chatBox.innerHTML = "";

                data.queries.forEach(query => {
                    if (query.role === "USER") {
                        chatBox.innerHTML += `<div class="chat-message user-message bg-green-200 p-3 rounded-lg max-w-full self-end shadow-md"><strong>You (${query.query_breed}):</strong> ${query.message}</div><br>`;
                    } else if (query.role === "BOT") {
                        chatBox.innerHTML += `<div class="chat-message bot-message bg-white p-3 rounded-lg max-w-full shadow-md">${formatResponse(query.message)}</div>`;
                    }
                });

                chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch(() => {
                chatBox.innerHTML = `<p style="color: red;">Error loading chat.</p>`;
            });
        }

        function addChatToSidebar(chatId, chatTitle) {
            let chatList = document.getElementById("chat-list");

            let chatItem = document.createElement("div");
            chatItem.className = "flex justify-between items-center p-2 bg-green-700 rounded-lg";
            chatItem.setAttribute("data-id", chatId);

            chatItem.innerHTML = `
                <a href="#" onclick="loadChat('${chatId}')" class="text-white">${chatTitle}</a>
                <div class="flex gap-2">
                    <button onclick="renameChat('${chatId}')" class="text-white hover:text-yellow-400">‚úèÔ∏è</button>
                    <button onclick="deleteChat('${chatId}')" class="text-white hover:text-red-400">üóëÔ∏è</button>
                </div>
            `;

            chatList.appendChild(chatItem);
        }

        document.getElementById("new-chat-btn").addEventListener("click", () => {
            activeChatId = null;
            let chatBox = document.querySelector(".chat-box");

            // Clear the chat area
            chatBox.innerHTML = "";

            // Add placeholder text
            let placeholder = document.createElement("p");
            placeholder.classList.add("text-gray-500");
            placeholder.textContent = "New chat started. Ask a question...";
            chatBox.appendChild(placeholder);

            // Remove the placeholder text after 3 seconds
            setTimeout(() => {
                if (chatBox.contains(placeholder)) {
                    placeholder.remove();
                }
            }, 3000);
        });

        function updateBreedImage() {
            let breedSelect = document.getElementById("breed-select");
            let selectedOption = breedSelect.options[breedSelect.selectedIndex];
            let imageContainer = document.querySelectorAll(".breed-image");

            let images = selectedOption.getAttribute("data-images").split(",");

            if (images.length > 0) {
                let selectedImages = images.sort(() => Math.random() - 0.5).slice(0, 3);

                imageContainer.forEach((img, index) => {
                    if (selectedImages[index]) {
                        img.src = selectedImages[index];
                        img.style.display = "block";
                    } else {
                        img.style.display = "none"; // Hide extra images if less than 3
                    }
                });
            }
        }

        function renameChat(chatId) {
            let newTitle = prompt("Enter new chat name:");
            if (!newTitle) return;

            fetch(`/rename_chat/${chatId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ new_title: newTitle })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let chatElement = document.querySelector(`#chat-list div[data-id='${chatId}'] a`);
                    if (chatElement) {
                        chatElement.textContent = newTitle;
                    }
                } else {
                    alert("Failed to rename chat.");
                }
            })
            .catch(() => alert("Error renaming chat."));
        }

        function deleteChat(chatId) {
            if (!confirm("Are you sure you want to delete this chat?")) return;

            fetch(`/delete_chat/${chatId}`, { method: "DELETE" })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let chatItem = document.querySelector(`#chat-list div[data-id='${chatId}']`);
                    if (chatItem) {
                        chatItem.remove();
                    }
                    // If the deleted chat was active, clear the chat box
                    if (activeChatId === chatId) {
                        activeChatId = null;
                        let chatBox = document.querySelector(".chat-box");
                        chatBox.innerHTML = `<p class="text-gray-500" id="clear-message">Chat cleared.</p>`;

                        // Remove the "Chat cleared." message after 2 seconds
                        setTimeout(() => {
                            let clearMessage = document.getElementById("clear-message");
                            if (clearMessage) {
                                clearMessage.remove();
                            }
                        }, 2000);
                    }
                } else {
                    alert("Failed to delete chat.");
                }
            })
            .catch(() => alert("Error deleting chat."));
        }


        window.onload = updateBreedImage;
    </script>
</body>
</html>
